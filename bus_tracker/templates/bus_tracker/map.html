<!DOCTYPE html>
<html>
<head>
    <title>MITS Bus Tracker - Real-Time GPS</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; }
        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            min-width: 250px;
        }
        .status { 
            padding: 5px 0; 
            font-size: 14px;
        }
        .status.online { color: green; }
        .status.offline { color: red; }
        .coordinates { 
            font-family: monospace; 
            background: #f5f5f5; 
            padding: 5px; 
            border-radius: 4px;
            margin: 5px 0;
        }
        .button {
            background: #007cba;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 5px 5px 0;
            font-size: 12px;
        }
        .button:hover { background: #005a8b; }
        .button:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="info-panel">
        <h3><i class="fas fa-bus"></i> MITS Bus Tracker</h3>
        <div class="status" id="connection-status">
            <i class="fas fa-circle"></i> Connecting...
        </div>
        <div class="coordinates" id="current-location">
            Lat: --<br>
            Lng: --<br>
            Updated: --
        </div>
        {% if firebase_enabled %}
        <button class="button" onclick="initializeFirebase()">
            <i class="fas fa-sync"></i> Connect Firebase
        </button>
        {% endif %}
        <button class="button" onclick="toggleSimulation()">
            <i class="fas fa-play"></i> Toggle Demo
        </button>
        <button class="button" onclick="showRoute()">
            <i class="fas fa-route"></i> Show Route
        </button>
        <button class="button" onclick="centerOnBus()">
            <i class="fas fa-crosshairs"></i> Center
        </button>
        <button class="button" onclick="resetToMITS()">
            <i class="fas fa-home"></i> MITS
        </button>
        <button class="button" onclick="testGPS()">
            <i class="fas fa-location-arrow"></i> Test GPS
        </button>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Initialize map centered on MITS
        const map = L.map('map').setView([9.9651, 76.4085], 15);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // MITS to Kolenchery route coordinates
        const routeCoords = [
            [9.964895591145599, 76.40958668953346], // MITS
            [9.964901, 76.407333],
            [9.965111, 76.408159],
            [9.965217, 76.408298],
            [9.965238, 76.408481],
            [9.965322, 76.408685],
            [9.965375, 76.408856],
            [9.965365, 76.409114],
            [9.965418, 76.409253],
            [9.965502, 76.409414],
            [9.965502, 76.409607],
            [9.965597, 76.409758],
            [9.965661, 76.409994],
            [9.965713, 76.410187],
            [9.965756, 76.410358],
            [9.965766, 76.410509],
            [9.965787, 76.410659],
            [9.965766, 76.410809],
            [9.965859, 76.410975]  // Kolenchery direction
        ];

        // Bus icon - more visible
        const busIcon = L.divIcon({
            html: '<div style="background: white; border: 2px solid #ff4444; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"><i class="fas fa-bus" style="color: #ff4444; font-size: 18px;"></i></div>',
            className: '',
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });

        // Initialize bus marker
        let busMarker = L.marker(routeCoords[0], { icon: busIcon }).addTo(map);
        let routeLine = null;
        let isSimulating = false;
        let simulationInterval = null;
        let currentIndex = 0;

        // Firebase connection status
        let firebaseConnected = false;

        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connection-status');
            if (status === 'online') {
                statusEl.innerHTML = '<i class="fas fa-circle" style="color: green;"></i> GPS Connected';
                statusEl.className = 'status online';
                firebaseConnected = true;
            } else if (status === 'firebase') {
                statusEl.innerHTML = '<i class="fas fa-database" style="color: blue;"></i> Firebase Connected';
                statusEl.className = 'status online';
            } else {
                statusEl.innerHTML = '<i class="fas fa-circle" style="color: red;"></i> Offline';
                statusEl.className = 'status offline';
                firebaseConnected = false;
            }
        }

        function updateLocationDisplay(lat, lng, timestamp = null, speed = null, accuracy = null) {
            const locationEl = document.getElementById('current-location');
            const timeStr = timestamp ? new Date(timestamp).toLocaleTimeString() : 'Now';
            let html = `Lat: ${lat.toFixed(6)}<br>Lng: ${lng.toFixed(6)}<br>Updated: ${timeStr}`;
            
            if (speed !== null) {
                html += `<br>Speed: ${speed} km/h`;
            }
            if (accuracy !== null) {
                html += `<br>Accuracy: ${accuracy}m`;
            }
            
            locationEl.innerHTML = html;
        }

        function updateBusLocation(lat, lng, timestamp = null, speed = null, accuracy = null) {
            const latLng = L.latLng(lat, lng);
            busMarker.setLatLng(latLng);
            updateLocationDisplay(lat, lng, timestamp, speed, accuracy);
            updateConnectionStatus('online');
            
            // Optionally center map on new location
            // map.setView(latLng, 17);
        }

        // Fetch latest location from server
        function fetchLatestLocation() {
            fetch('/api/latest/')
                .then(response => response.json())
                .then(data => {
                    if (data.lat !== 0 || data.lng !== 0) {
                        updateBusLocation(data.lat, data.lng, data.timestamp);
                    } else {
                        updateConnectionStatus('offline');
                    }
                })
                .catch(error => {
                    console.error('Error fetching location:', error);
                    updateConnectionStatus('offline');
                });
        }

        // Initialize Firebase connection
        function initializeFirebase() {
            {% if firebase_enabled %}
            fetch('/api/firebase/init/', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status) {
                        updateConnectionStatus('firebase');
                        console.log('Firebase initialized successfully');
                        // Start polling for Firebase updates
                        setInterval(fetchFirebaseLocation, 3000);
                    } else {
                        console.error('Firebase initialization failed:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Firebase initialization error:', error);
                });
            {% else %}
            alert('Firebase not configured. Please set up firebase_config.py');
            {% endif %}
        }

        // Fetch location from Firebase
        function fetchFirebaseLocation() {
            fetch('/api/firebase/latest/')
                .then(response => response.json())
                .then(data => {
                    if (data.lat && data.lng) {
                        updateBusLocation(data.lat, data.lng, data.timestamp);
                    }
                })
                .catch(error => console.error('Error fetching Firebase location:', error));
        }

        // Demo simulation functions
        function toggleSimulation() {
            if (isSimulating) {
                clearInterval(simulationInterval);
                isSimulating = false;
                document.querySelector('button[onclick="toggleSimulation()"]').innerHTML = '<i class="fas fa-play"></i> Start Demo';
            } else {
                startSimulation();
                isSimulating = true;
                document.querySelector('button[onclick="toggleSimulation()"]').innerHTML = '<i class="fas fa-stop"></i> Stop Demo';
            }
        }

        function startSimulation() {
            simulationInterval = setInterval(() => {
                if (currentIndex < routeCoords.length) {
                    const [lat, lng] = routeCoords[currentIndex];
                    updateBusLocation(lat, lng);
                    currentIndex++;
                } else {
                    currentIndex = 0; // Loop back
                }
            }, 3000); // 3 seconds per point
        }

        function showRoute() {
            if (routeLine) {
                map.removeLayer(routeLine);
                routeLine = null;
            } else {
                routeLine = L.polyline(routeCoords, { 
                    color: 'blue', 
                    weight: 4,
                    opacity: 0.7 
                }).addTo(map);
                map.fitBounds(routeLine.getBounds());
            }
        }

        function centerOnBus() {
            map.setView(busMarker.getLatLng(), 17);
        }

        function resetToMITS() {
            const mitsLocation = [9.964895591145599, 76.40958668953346];
            busMarker.setLatLng(mitsLocation);
            map.setView(mitsLocation, 17);
            updateLocationDisplay(mitsLocation[0], mitsLocation[1]);
        }

        function testGPS() {
            // Send a test GPS coordinate
            const testCoords = [9.9651, 76.4085];
            fetch('/api/update/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    lat: testCoords[0],
                    lng: testCoords[1],
                    speed: Math.random() * 50 + 10, // Random speed 10-60 km/h
                    accuracy: Math.random() * 10 + 2 // Random accuracy 2-12m
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Test GPS sent:', data);
                updateBusLocation(testCoords[0], testCoords[1]);
            })
            .catch(error => console.error('Error:', error));
        }

        // Start with initial data fetch
        updateConnectionStatus('offline');
        fetchLatestLocation();

        // Poll for location updates every 5 seconds
        setInterval(fetchLatestLocation, 5000);

        // Add markers for start and end points
        L.marker(routeCoords[0], {
            icon: L.divIcon({
                html: '<i class="fas fa-school" style="color: green;"></i>',
                className: '',
                iconSize: [20, 20]
            })
        }).addTo(map).bindPopup("MITS College");

        L.marker(routeCoords[routeCoords.length - 1], {
            icon: L.divIcon({
                html: '<i class="fas fa-map-marker-alt" style="color: red;"></i>',
                className: '',
                iconSize: [20, 20]
            })
        }).addTo(map).bindPopup("Kolenchery Direction");

    </script>
</body>
</html>

